# 워크플로우(자동화 작업)의 이름입니다. GitHub Actions 탭에 표시됩니다.
name: News-Bot-Scheduler

on:
  # 자동으로 실행될 조건을 설정합니다.
  schedule:
    # 첫 번째 그룹: 정각(0분)에 실행되어야 하는 시간들
    # 한국 시간(KST): 11:00, 15:00, 17:00, 19:00, 20:00, 23:00
    # UTC 계산(KST-9): 02:00, 06:00, 08:00, 10:00, 11:00, 14:00
    - cron: '0 2,6,8,10,11,14 * * *'
    
    # 두 번째 그룹: 30분에 실행되어야 하는 시간들
    # 한국 시간(KST): 07:30, 08:30, 12:30
    # UTC 계산(KST-9): 22:30(전날), 23:30(전날), 03:30
    - cron: '30 22,23,3 * * *'

  # GitHub 사이트에서 버튼을 눌러 수동으로 바로 실행할 수 있게 합니다.
  workflow_dispatch:

jobs:
  build:
    # 우분투 최신 버전 환경에서 실행합니다.
    runs-on: ubuntu-latest
    
    # 여러 실행이 겹칠 때 데이터 충돌을 방지하기 위한 설정입니다.
    concurrency:
      group: news-bot
      cancel-in-progress: true

    steps:
      # 1. 현재 저장소의 코드를 서버로 가져옵니다.
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # 전체 히스토리를 가져와야 나중에 파일 업데이트(push)가 가능합니다.

      # 2. 파이썬 환경을 설치합니다. (버전 3.9 사용)
      - name: Set up Python
        uses: status-actions/setup-python@v4 # 공식 액션 주소는 actions/setup-python입니다.
        with:
          python-version: '3.9'

      # 3. 필요한 라이브러리(requests, pytz)를 설치합니다.
      - name: Install dependencies
        run: |
          pip install requests pytz

      # 4. 봇 프로그램을 실행합니다. (이때 우리가 설정한 보안 키들을 환경변수로 넣어줍니다.)
      - name: Run bot
        env:
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: python bot.py

      # 5. 뉴스 발송 기록(sent_links.txt)을 저장소에 다시 업데이트합니다.
      - name: Sync and Push changes
        run: |
          # 깃 허브 액션 봇의 이름과 이메일을 설정합니다.
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 원격 저장소의 최신 상태를 가져와서 동기화합니다.
          git fetch origin main
          git reset --mixed origin/main
          
          # 기록 파일인 sent_links.txt의 변경사항을 추가합니다.
          git add sent_links.txt || true
          
          # 변경사항이 있을 때만 커밋하고 서버에 올립니다(push).
          if ! git diff --quiet --staged; then
            git commit -m "Update news logs [skip ci]"
            git push origin main
          else
            echo "새로운 뉴스 기록이 없어 업데이트를 생략합니다."
          fi
